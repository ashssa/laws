# ./.github/workflows/deploy.yml

name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main # ä¸»è¦åˆ†æ”¯

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- ğŸ“¦ å®‰è£ Node.js å’Œ pnpm (å¾ CI workflow è¤‡è£½) ---

      - name: "ğŸ“¦ Install pnpm"
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.1

      - name: "Use Node.js 20"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
          # ç”±æ–¼ pnpm é–å®šåœ¨ Astro å°ˆæ¡ˆç›®éŒ„ä¸‹å®‰è£ï¼Œé€™è£¡çš„ cache-dependency-path ä¸éœ€è¦è¨­å®š

      # --- ğŸš€ å»ºç½® Astro å°ˆæ¡ˆ (æ–°å¢æ­¥é©Ÿ) ---
      
      # é€²å…¥ Astro å°ˆæ¡ˆç›®éŒ„å®‰è£ä¾è³´
      - name: "ğŸ“¦ Install Astro dependencies"
        run: pnpm install
        working-directory: ./blog-src # ç¢ºä¿åœ¨ ./blog-src è·¯å¾‘ä¸‹åŸ·è¡Œ pnpm install

      # å»ºç½® Astro å°ˆæ¡ˆ
      - name: "ğŸš€ Build the Astro project"
        # åŸ·è¡Œ build scriptã€‚ç”±æ–¼æ‚¨å·²åœ¨ astro.config.mjs ä¸­è¨­å®š outDir: '../public/blog' 
        # ä¸” base: '/blog'ï¼Œæ‰€ä»¥å»ºç½®çµæœæœƒæ­£ç¢ºè¼¸å‡ºåˆ°ä¸»å°ˆæ¡ˆçš„ ./public/blog
        run: pnpm run build
        working-directory: ./blog-src # ç¢ºä¿åœ¨ ./blog-src è·¯å¾‘ä¸‹åŸ·è¡Œ pnpm run build

      # --- ğŸ“ åŸ·è¡ŒåŸæœ¬çš„ Service Worker å’Œ HTML è™•ç† ---

      - name: Generate Service Worker cache version
        id: generate_sw_version
        run: |
          # ä½¿ç”¨æäº¤çš„çŸ­ SHA ä½œç‚º Service Worker ç‰ˆæœ¬è™Ÿ
          SW_VERSION=$(git rev-parse --short HEAD)
          echo "Generated Service Worker cache version: $SW_VERSION"
          echo "SW_VERSION=$SW_VERSION" >> $GITHUB_ENV

      - name: Update Service Worker cache name
        run: |
          # æ›¿æ› public/config/sw.js ä¸­çš„ä½”ä½ç¬¦
          sed -i "s/%%VERSION%%/${{ env.SW_VERSION }}/g" ./public/config/sw.js
          echo "Updated sw.js with cache version ${{ env.SW_VERSION }}"

      - name: Get current date (UTC+8)
        id: date
        env:
          TZ: Asia/Taipei
        run: echo "DATE=$(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S') (UTC+8)" >> $GITHUB_OUTPUT 

      - name: Update date in HTML
        run: |
          # ç”±æ–¼æ‚¨çš„ Astro å°ˆæ¡ˆå·²åœ¨ './public/blog' ä¸­ç”Ÿæˆï¼Œé€™å€‹æ­¥é©Ÿæ‡‰è©²æ˜¯è¦ä¿®æ”¹
          # å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹çš„ public/components/footer.html (å¦‚æœå®ƒä¸æ˜¯ Astro çš„ä¸€éƒ¨åˆ†)
          sed -i "s|<span id=\"last-updated-date\">.*</span>|<span id=\"last-updated-date\">${{ steps.date.outputs.DATE }}</span>|g" ./public/components/footer.html
          
      # --- éƒ¨ç½²åˆ° GitHub Pages ---

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public # å¾ public è³‡æ–™å¤¾éƒ¨ç½²ï¼Œå…¶ä¸­åŒ…å«äº† Astro ç”Ÿæˆçš„ blog