# ./.github/workflows/deploy.yml

name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main # åªæœ‰ç•¶æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼éƒ¨ç½²

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # è¨­å®šå¿…è¦çš„æ¬Šé™
    permissions:
      contents: write 
      pages: write
      id-token: write

    steps:
      - name: â˜ï¸ Checkout code
        uses: actions/checkout@v4

      # --- ğŸ“¦ è¨­å®šç’°å¢ƒèˆ‡å®‰è£ä¾è³´ (é‡å°æ•´å€‹ monorepo) ---

      - name: "ğŸ“¦ Install pnpm"
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.1

      - name: "Use Node.js 20"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      # å‡è¨­ä¸»å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹æœ‰ package.jsonï¼Œä¹Ÿéœ€è¦å®‰è£ä¸»å°ˆæ¡ˆçš„ä¾è³´
      # âš ï¸ å¦‚æœä¸»å°ˆæ¡ˆæ ¹ç›®éŒ„æ²’æœ‰ package.jsonï¼Œè«‹åˆªé™¤æ­¤æ­¥é©Ÿ
      - name: "ğŸ“¦ Install Root dependencies"
        run: pnpm install

      # --- ğŸš€ å»ºç½® Astro å°ˆæ¡ˆ (é‡é») ---
      
      # é€²å…¥ Astro å°ˆæ¡ˆç›®éŒ„å®‰è£ä¾è³´
      - name: "ğŸ“¦ Install Astro dependencies"
        # ç”±æ–¼ Astro å°ˆæ¡ˆæœ‰è‡ªå·±çš„ package.jsonï¼Œæˆ‘å€‘åœ¨è©²ç›®éŒ„ä¸‹é‡æ–°å®‰è£
        run: pnpm install
        working-directory: ./blog-src 

      # å»ºç½® Astro å°ˆæ¡ˆ
      - name: "ğŸš€ Build the Astro project"
        # åŸ·è¡Œ build scriptã€‚å®ƒæœƒæ ¹æ“š astro.config.mjs å°‡æª”æ¡ˆè¼¸å‡ºåˆ° ../public/blog
        run: pnpm run build
        working-directory: ./blog-src 

      # --- ğŸ“ åŸ·è¡ŒåŸæœ¬çš„ Service Worker å’Œ HTML è™•ç† ---
      # é€™äº›æ­¥é©Ÿå°‡å°ä¸»å°ˆæ¡ˆçš„ ./public ç›®éŒ„ä¸‹çš„æª”æ¡ˆé€²è¡Œæ“ä½œ
      
      - name: Generate Service Worker cache version
        id: generate_sw_version
        run: |
          SW_VERSION=$(git rev-parse --short HEAD)
          echo "SW_VERSION=$SW_VERSION" >> $GITHUB_ENV

      - name: Update Service Worker cache name
        # æ›¿æ›ä¸»å°ˆæ¡ˆ public/config/sw.js ä¸­çš„ä½”ä½ç¬¦
        run: sed -i "s/%%VERSION%%/${{ env.SW_VERSION }}/g" ./public/config/sw.js

      - name: Get current date (UTC+8)
        id: date
        env:
          TZ: Asia/Taipei
        run: echo "DATE=$(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S') (UTC+8)" >> $GITHUB_OUTPUT 

      - name: Update date in HTML
        # ä¿®æ”¹ä¸»å°ˆæ¡ˆ public/components/footer.html
        run: |
          sed -i "s|<span id=\"last-updated-date\">.*</span>|<span id=\"last-updated-date\">${{ steps.date.outputs.DATE }}</span>|g" ./public/components/footer.html
          
      # --- éƒ¨ç½²åˆ° GitHub Pages ---

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # é—œéµï¼šå¾ ./public è³‡æ–™å¤¾éƒ¨ç½²
          # æ­¤æ™‚ public/ ç›®éŒ„åŒ…å«ï¼š
          # 1. ä¸»å°ˆæ¡ˆåŸæœ‰çš„æª”æ¡ˆ (e.g. index.html, public/config/sw.js)
          # 2. Astro å°ˆæ¡ˆå»ºç½®å¾Œè¼¸å‡ºçš„æª”æ¡ˆ (public/blog/...)
          publish_dir: ./public